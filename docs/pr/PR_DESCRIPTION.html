<h2>עדכון זרימת ארגונים, שיפורי דיווח, מעבר ל‑SerpAPI ושיפורי Geocoding</h2>

<h3>רקע ומטרות</h3>
<p>
שיפור תהליך הוספת ארגונים כדי לדייק התראות לפי מיקום ולהעדיף ערוצי קשר מידיים (טלפון/WhatsApp/SMS),
הוספת אפשרות לדיווח ללא תמונה, הורדת עלויות באיסוף פרטי קשר באמצעות SerpAPI, ושיפור זיהוי כתובת/עיר גם כש‑Google לא מחזיר תוצאה.
</p>

<h3>שינויים פונקציונליים</h3>
<ul>
  <li><b>הוסף ארגון – שדה מיקום בשלב ההוספה:</b> ברגע הוספה נשמרים <code>latitude/longitude</code>, כתובת ועיר (best‑effort).</li>
  <li><b>הוסף ארגון – שלב אימייל עם דילוג:</b> כפתור <code>דלג</code> (inline) בשלב האימייל. אימייל משמש בעיקר לתיעוד/מעקב, לא כהתראה ראשית.</li>
  <li><b>הוסף ארגון – הוסף טלפון:</b> כפתור <code>הוסף טלפון</code> בשלב האימייל. אימות בסיסי, שמירה ל‑<code>primary_phone</code>.</li>
  <li><b>קבלת מיקום בשלב האימייל:</b> תוקן ה‑state כך שמטפל גם ב‑<code>LOCATION</code>; שיתוף מיקום נקלט ונשמר.</li>
  <li><b>דיווח ללא תמונה:</b> בשלב התמונות מוצג מראש כפתור <code>המשך למיקום</code> (דלג) — ניתן לדווח גם בלי תמונה.</li>
  <li><b>שיפור Geocoding:</b>
    <ul>
      <li><b>Fallback ל‑Nominatim (OSM):</b> כש‑Google לא מחזיר עיר/כתובת, ננסה OSM ונמזג תוצאה.</li>
      <li><b>Cache בזיכרון:</b> לתוצאות reverse geocode להקטנת כשלי רשת/עלות.</li>
      <li><b>אם עדיין אין עיר:</b> מוצג כפתור <code>הכנס כתובת ידנית</code> וגם <code>דלג</code>, ונשארים בשלב המיקום עד קלט/דלג.</li>
    </ul>
  </li>
  <li><b>העדפת ערוצי התראה:</b>
    <ul>
      <li>בעת יצירת ארגון <u>לא</u> נקבע <code>email</code> כברירת מחדל לערוצי התראה.</li>
      <li>משימת רקע <code>reconcile_alert_channels</code> מעדכנת אוטומטית:
        <ul>
          <li>אם יש טלפון → <code>whatsapp</code>, <code>sms</code></li>
          <li>אם יש <code>telegram_chat_id</code> → <code>telegram</code></li>
          <li>אימייל נשאר לתיעוד/מעקב בלבד (לא כערוץ התראה ראשי).</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3>שינויים בקוד ובשיחות (Bot)</h3>
<ul>
  <li><b>מצב ADMIN_ADD_ORG_EMAIL:</b> כעת קולט גם <code>filters.LOCATION</code>.</li>
  <li><b>Inline actions בשלב אימייל:</b> <code>דלג</code> + <code>הוסף טלפון</code> עם handlers תואמים.</li>
  <li><b>דיווח:</b> בשלב התמונות — כפתור <code>המשך למיקום</code> כברירת מחדל (דלג על תמונה).</li>
</ul>

<h3>שירותי צד ג׳</h3>
<ul>
  <li><b>SerpAPI:</b> משמש להשלמת פרטי קשר (טלפון/אתר) בעלות נמוכה יחסית ל‑Google Places Details.</li>
  <li><b>Geocoding:</b> שיפורים ב‑<code>GeocodingService</code> — Fallback ל‑Nominatim + Cache.</li>
</ul>

<h3>קונפיג (ENV)</h3>
<ul>
  <li><code>SERPAPI_KEY</code> – מפתח SerpAPI (לשליפת טלפון/אתר)</li>
  <li>עודכן <code>.env.example</code> עם כל המשתנים המרכזיים</li>
  <li>ה‑README עודכן להפניה ל‑<code>.env.example</code>.</li>
</ul>

<h3>מסד נתונים</h3>
<ul>
  <li>מודל <code>Organization</code> כולל שדות: <code>primary_phone</code>, <code>email</code>, <code>website</code>, <code>latitude</code>, <code>longitude</code>, <code>city</code>, <code>address</code>, <code>google_place_id</code>, ו‑<code>alert_channels</code>.</li>
  <li>בעת יצירה, <code>alert_channels</code> מתחיל ריק; משימת הרקע מעדכנת לפי פרטי קשר בפועל.</li>
  <li>בהוספת טלפון ידנית בשלב ההוספה, נשמר <code>primary_phone</code> ומערכת הרקע תעדכן את הערוצים.</li>
</ul>

<h3>משימות רקע (RQ Scheduler)</h3>
<ul>
  <li><b>reconcile_alert_channels (שעתית):</b> מעדכן ערוצי התראה לפי טלפון/טלגרם (מונע שימוש אימייל כהתראה).</li>
  <li><b>enrich_org_contacts_with_serpapi:</b> העשרת טלפון/אתר מארגונים חסרים.</li>
</ul>

<h3>בדיקות ותיקונים</h3>
<ul>
  <li><b>מבחנים:</b> וידוא ש‑<code>ADMIN_ADD_ORG_EMAIL</code> מקבל <code>LOCATION</code>; בדיקת אימייל לא תקין — הודעה משלבת אזהרה+הוראות; זרימת דיווח ללא תמונה.</li>
  <li><b>תיקון סטאב אפליקציה:</b> הוספת <code>add_error_handler</code> ל‑<code>_FakeApplication</code> במבחן.</li>
  <li>לינט נקי.</li>
</ul>

<h3>איך נרשמים ל‑SerpAPI</h3>
<ol>
  <li>נרשמים באתר <a href="https://serpapi.com/" target="_blank" rel="noopener noreferrer">SerpAPI</a>.</li>
  <li>מעתיקים את ה‑API Key מה‑Dashboard.</li>
  <li>מגדירים <code>SERPAPI_KEY</code> ב‑ENV/Secrets בסביבות הרלוונטיות.</li>
  <li>מומלץ להגדיר קצב שימוש ותוכנית תואמת לעומס.</li>
  <li>חבילה בשימוש: <code>google-search-results</code> (ראה <code>requirements.txt</code>).</li>
</ol>

<h3>Deployment</h3>
<ul>
  <li>להגדיר <code>SERPAPI_KEY</code> לפני עלייה.</li>
  <li>להפעיל מתזמן (Scheduler) כדי ש‑<code>reconcile_alert_channels</code> ירוץ שעתית.</li>
  <li>ה‑README עודכן, כולל <code>.env.example</code>.</li>
</ul>

<h3>סיכונים ושיקולים</h3>
<ul>
  <li><b>SerpAPI:</b> עלויות/Rate Limit — יש קאשינג, ותורים במשימות רקע מפחיתים עלויות.</li>
  <li><b>דיוק מיקום:</b> Fallback ל‑OSM משפר זיהוי עיר אך תלוי בזמינות OSM; קלט ידני למקרי קצה.</li>
  <li><b>ערוצי התראה:</b> אימייל לתיעוד בלבד — הודעות תפעוליות מתבססות על טלפון/טלגרם.</li>
</ul>

<h3>Rollback</h3>
<ul>
  <li>כיבוי משימות הרקע/חזרה לערוצי התראה ידניים.</li>
  <li>ניתוק Fallback ל‑Nominatim והשענות רק על Google (ב‑<code>GeocodingService</code>).</li>
</ul>

<h3>צילומי מסך (לבקשה)</h3>
<details>
  <summary>הוספת ארגון – דילוג אימייל והוספת טלפון</summary>
</details>
<details>
  <summary>דיווח – דילוג על תמונה</summary>
</details>
<details>
  <summary>מיקום – הצעת כתובת ידנית כשאין עיר</summary>
</details>

